<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Pages</title>
    <!-- Thêm Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .redPoint {
            color: red;
            border: 1px solid red;
            border-radius: 5px;
            font-size: 1.5rem;
            padding: 5px 10px;
        }

        .pagination-button {
            margin: 5px;
            padding: 10px;
            cursor: pointer;
        }

        .pagination {
            margin: 20px 0;
        }

        .table-container {
            margin-top: 20px;
        }

        .search-bar {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Danh Sách Nữ Diễn Viên</h1>

        <div class="form-group search-bar">
            <input type="text" class="form-control" id="searchByName" placeholder="Tìm kiếm theo tên">
            <input type="number" class="form-control mt-2" id="searchByPoint" placeholder="Tìm kiếm theo điểm" min="1"
                max="10">

        </div>

        <div class="form-group">
            <input type="text" class="form-control" id="actressName" placeholder="Nhập tên nữ diễn viên">
        </div>

        <div class="form-group">
            <input type="number" class="form-control" id="point" placeholder="Điểm" min="1" max="10">
        </div>

        <button id="saveButton" class="btn btn-primary">Lưu</button>

        <div class="form-group mt-3">
            <input type="text" class="form-control" id="weburl" placeholder="Nhập đường dẫn bạn mong muốn"
                value="https://javtiful.com/actress/">
        </div>

        <div id="pagination" class="pagination"></div>

        <button id="refresh" class="btn btn-secondary mt-2">Refresh</button>
        <button id="sort" class="btn btn-info mt-2">Sort</button>

        <!-- Bảng hiển thị danh sách diễn viên -->
        <div id="tableContainer" class="table-container">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Tên</th>
                        <th>Điểm</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody id="actressList"></tbody> <!-- Danh sách diễn viên sẽ được chèn vào đây -->
            </table>
        </div>
    </div>

    <!-- Thêm jQuery và Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function openPage(url) {
            window.open(url, "_blank"); // Mở trang web trong cửa sổ mới
        }

        document.getElementById("sort").addEventListener("click", function () {
            sortActressesByPoint();
        });

        function sortActressesByPoint() {
            fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress")
                .then(response => response.json())
                .then(data => {
                    data.sort((a, b) => b.point - a.point); // Sắp xếp theo điểm giảm dần
                    updateActressList(data); // Cập nhật danh sách sau khi đã sắp xếp
                })
                .catch(error => console.error("Lỗi khi lấy dữ liệu từ API:", error));
        }

        function updateActressList(data) {
            var actressList = document.getElementById("actressList");
            actressList.innerHTML = ""; // Xóa danh sách hiện tại
            data.forEach((actress, index) => {
                var actressIndex = index + 1;
                var row = document.createElement('tr');
                row.innerHTML = `
                    <td>${actressIndex}</td>
                    <td>${actress.name}</td>
                    <td class="redPoint">${actress.point}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteActress('${actress.id}')">Xóa</button>
                        <button class="btn btn-info btn-sm" onclick="searchActress('${actress.name}')">Tìm kiếm</button>
                        <button class="btn btn-warning btn-sm" onclick="editActress('${actress.id}', '${actress.point}')">Chỉnh sửa</button>
                    </td>
                `;
                actressList.appendChild(row);
            });
        }

        function searchActress(name) {
            var url = document.getElementById("weburl").value;
            var actressName = name.replace(/\s+/g, '-');
            openPage(url + actressName);
        }

        function editActress(id, point) {
            const newPoint = prompt(`Chỉnh lại điểm Point của diễn viên: ${point}`);

            if (newPoint !== null) {
                updateActressPoint(id, newPoint);
            }
        }

        async function updateActressPoint(id, point) {
            try {
                const response = await fetch(`https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ point: point })
                });

                if (response.ok) {
                    console.log('Dữ liệu đã được cập nhật thành công.');
                    location.reload();
                } else {
                    console.error('Lỗi khi cập nhật dữ liệu:', response.statusText);
                }
            } catch (error) {
                console.error('Lỗi:', error.message);
            }
        }

        document.getElementById("refresh").addEventListener("click", function () {
            fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress")
                .then(response => response.json())
                .then(data => {
                    let existingNames = {};

                    for (let item of data) {
                        let nameLowerCase = item.name.toLowerCase();
                        if (!existingNames[nameLowerCase]) {
                            existingNames[nameLowerCase] = true;
                        } else {
                            fetch(`https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress/${item.id}`, {
                                method: 'DELETE'
                            })
                                .then(response => {
                                    if (response.ok) {
                                        console.log(`Đã xóa dữ liệu trùng lặp với ID ${item.id} thành công.`);
                                        location.reload();
                                    } else {
                                        throw new Error(`Không thể xóa dữ liệu trùng lặp với ID ${item.id}.`);
                                    }
                                })
                                .catch(error => {
                                    console.error('Đã xảy ra lỗi:', error);
                                });
                        }
                    }
                })
                .catch(error => {
                    console.error('Đã xảy ra lỗi khi tải dữ liệu:', error);
                });
        });

        document.getElementById("saveButton").addEventListener("click", function () {
            var actressName = document.getElementById("actressName").value;
            var actressPoint = document.getElementById("point").value;

            saveToApi(actressName, actressPoint);
        });

        function saveToApi(name, point) {
            fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    name: name,
                    point: point
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("Dữ liệu đã được lưu lên API:", data);
                    location.reload(); // Reload lại trang sau khi lưu dữ liệu
                })
                .catch(error => console.error("Lỗi khi lưu dữ liệu:", error));
        }

        function deleteActress(id) {
            fetch(`https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress/${id}`, {
                method: 'DELETE',
            })
                .then(response => response.json())
                .then(data => console.log("Đã xóa:", data))
                .catch(error => console.error("Lỗi khi xóa:", error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            const dataSearch = {
                name: '',
                point: ''
            };

            document.getElementById('searchByName').addEventListener('input', function () {
                dataSearch.name = this.value.toLowerCase();
                search();
            });

            document.getElementById('searchByPoint').addEventListener('input', function () {
                dataSearch.point = this.value;
                search();
            });

            function search() {
                fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress")
                    .then(response => response.json())
                    .then(data => {
                        const filteredData = data.filter(actress => {
                            const matchesName = dataSearch.name === '' || actress.name.toLowerCase().includes(dataSearch.name);
                            const matchesPoint = dataSearch.point === '' || actress.point == dataSearch.point;
                            return matchesName && matchesPoint;
                        });
                        updateActressList(filteredData);
                    })
                    .catch(error => console.error("Lỗi khi tìm kiếm:", error));
            }

            function updateActressList(data) {
                var actressList = document.getElementById("actressList");
                actressList.innerHTML = ""; // Xóa danh sách hiện tại
                data.forEach((actress, index) => {
                    var actressIndex = index + 1;
                    var row = document.createElement('tr');
                    row.innerHTML = `
                <td>${actressIndex}</td>
                <td>${actress.name}</td>
                <td class="redPoint">${actress.point}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteActress('${actress.id}')">Xóa</button>
                    <button class="btn btn-info btn-sm" onclick="searchActress('${actress.name}')">Tìm kiếm</button>
                    <button class="btn btn-warning btn-sm" onclick="editActress('${actress.id}', '${actress.point}')">Chỉnh sửa</button>
                </td>
            `;
                    actressList.appendChild(row);
                });
            }

            function searchActress(name) {
                var url = document.getElementById("weburl").value;
                var actressName = name.replace(/\s+/g, '-');
                openPage(url + actressName);
            }

            function editActress(id, point) {
                const newPoint = prompt(`Chỉnh lại điểm Point của diễn viên: ${point}`);

                if (newPoint !== null) {
                    updateActressPoint(id, newPoint);
                }
            }

            async function updateActressPoint(id, point) {
                try {
                    const response = await fetch(`https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ point: point })
                    });

                    if (response.ok) {
                        console.log('Dữ liệu đã được cập nhật thành công.');
                        location.reload();
                    } else {
                        console.error('Lỗi khi cập nhật dữ liệu:', response.statusText);
                    }
                } catch (error) {
                    console.error('Lỗi:', error.message);
                }
            }

            document.getElementById("refresh").addEventListener("click", function () {
                fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress")
                    .then(response => response.json())
                    .then(data => {
                        let existingNames = {};

                        for (let item of data) {
                            let nameLowerCase = item.name.toLowerCase();
                            if (!existingNames[nameLowerCase]) {
                                existingNames[nameLowerCase] = true;
                            } else {
                                fetch(`https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress/${item.id}`, {
                                    method: 'DELETE'
                                })
                                    .then(response => {
                                        if (response.ok) {
                                            console.log(`Đã xóa dữ liệu trùng lặp với ID ${item.id} thành công.`);
                                            location.reload();
                                        } else {
                                            throw new Error(`Không thể xóa dữ liệu trùng lặp với ID ${item.id}.`);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Đã xảy ra lỗi:', error);
                                    });
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Đã xảy ra lỗi khi tải dữ liệu:', error);
                    });
            });

            document.getElementById("saveButton").addEventListener("click", function () {
                var actressName = document.getElementById("actressName").value;
                var actressPoint = document.getElementById("point").value;

                saveToApi(actressName, actressPoint);
            });

            function saveToApi(name, point) {
                fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        name: name,
                        point: point
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Dữ liệu đã được lưu lên API:", data);
                        location.reload(); // Reload lại trang sau khi lưu dữ liệu
                    })
                    .catch(error => console.error("Lỗi khi lưu dữ liệu:", error));
            }

            function deleteActress(id) {
                fetch(`https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress/${id}`, {
                    method: 'DELETE',
                })
                    .then(response => response.json())
                    .then(data => console.log("Đã xóa diễn viên:", data))
                    .catch(error => console.error("Lỗi khi xóa diễn viên:", error));
            }

            function createPaginationButtons(totalItems) {
                var paginationContainer = document.getElementById("pagination");
                paginationContainer.innerHTML = ""; // Xóa các nút phân trang hiện tại
                var numberOfPages = Math.ceil(totalItems / 10); // 10 là số item trên mỗi trang

                for (let i = 1; i <= numberOfPages; i++) {
                    var button = document.createElement('button');
                    button.classList.add('btn', 'btn-primary', 'pagination-button');
                    button.textContent = `Trang ${i}`;
                    button.addEventListener('click', () => openPages(i));
                    paginationContainer.appendChild(button);
                }
            }

            function openPages(pageNumber) {
                var itemsPerPage = 10;
                var startIndex = (pageNumber - 1) * itemsPerPage;
                var endIndex = startIndex + itemsPerPage;

                var url = document.getElementById("weburl").value;
                fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress")
                    .then(response => response.json())
                    .then(data => {
                        var pageData = data.slice(startIndex, endIndex);
                        pageData.forEach(actress => {
                            var actressName = actress.name.replace(/\s+/g, '-');
                            openPage(url + actressName);
                        });
                    })
                    .catch(error => console.error("Lỗi khi lấy dữ liệu từ API:", error));
            }

            function openPage(url) {
                window.open(url, "_blank"); // Mở trang web trong cửa sổ mới
            }
        });
    </script>

</body>

</html>