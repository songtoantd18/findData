<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Pages</title>
    <!-- Th√™m Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .redPoint {
            color: red;
            border: 1px solid red;
            border-radius: 5px;
            font-size: 20px;
            padding: 2px 5px;
        }

        .pagination-button {
            margin: 5px;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col">
                <input type="text" id="actressName" class="form-control" placeholder="Nh·∫≠p t√™n n·ªØ di·ªÖn vi√™n">
            </div>
            <div class="col">
                <input type="number" id="point" class="form-control" placeholder="ƒêi·ªÉm" min="1" max="10">
            </div>
            <div class="col">
                <button id="saveButton" class="btn btn-primary">L∆∞u</button>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <input type="text" id="weburl" class="form-control" placeholder="Nh·∫≠p ƒë∆∞·ªùng d·∫´n b·∫°n mong mu·ªën"
                    value="https://javtiful.com/actress/">
            </div>
        </div>

        <div id="pagination" class="mb-3"></div>

        <div class="row mb-3">
            <div class="col">
                <button id="refresh" onclick="RandomValue()" class="btn btn-success">Random</button>

                <button id="refresh" class="btn btn-secondary">Refresh</button>
                <button id="sort" class="btn btn-info">Sort</button>
                <input type="text" id="searchByNameAndPoint" class="form-control d-inline-block w-auto"
                    placeholder="Search by name and point">
            </div>
        </div>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>T√™n</th>
                    <th>ƒêi·ªÉm</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="actressList">
                <!-- Danh s√°ch n·ªØ di·ªÖn vi√™n s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </tbody>
        </table>
    </div>

    <!-- Th√™m Bootstrap JS v√† Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>

    <script>

        let dataValue = []
        function RandomValue() {
            var randomValue = Math.floor(Math.random() * dataValue.length);
            // console.log("üöÄ ~ RandomValue ~ dataValue.length:", dataValue.length)
            console.log("üöÄ ~ RandomValue ~ randomValue:", randomValue)
            console.log("üöÄ ~ dataValue:", dataValue[randomValue].name)


            var url = document.getElementById("weburl").value;
            var actressName = dataValue[randomValue].name.replace(/\s+/g, '-');
            openPage(url + actressName);

        }

        function openPage(url) {
            window.open(url, "_blank"); // M·ªü trang web trong c·ª≠a s·ªï m·ªõi
        }

        document.getElementById("sort").addEventListener("click", function () {
            sortActressesByPoint();
        });

        function sortActressesByPoint() {
            fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress")
                .then(response => response.json())
                .then(data => {
                    data.sort((a, b) => b.point - a.point); // S·∫Øp x·∫øp theo ƒëi·ªÉm gi·∫£m d·∫ßn
                    updateActressList(data); // C·∫≠p nh·∫≠t danh s√°ch sau khi ƒë√£ s·∫Øp x·∫øp
                })
                .catch(error => console.error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API:", error));
        }

        document.getElementById("refresh").addEventListener("click", function () {
            fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress")
                .then(response => response.json())
                .then(data => {
                    dataValue = data;

                    let existingNames = {};

                    for (let item of data) {
                        let nameLowerCase = item.name.toLowerCase();
                        if (!existingNames[nameLowerCase]) {
                            existingNames[nameLowerCase] = true;
                        } else {
                            // X√≥a d·ªØ li·ªáu tr√πng l·∫∑p t·ª´ API
                            fetch(`https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress/${item.id}`, {
                                method: 'DELETE'
                            })
                                .then(response => {
                                    if (response.ok) {
                                        console.log(`ƒê√£ x√≥a d·ªØ li·ªáu tr√πng l·∫∑p v·ªõi ID ${item.id} th√†nh c√¥ng.`);
                                        location.reload();
                                    } else {
                                        throw new Error(`Kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu tr√πng l·∫∑p v·ªõi ID ${item.id}.`);
                                    }
                                })
                                .catch(error => {
                                    console.error('ƒê√£ x·∫£y ra l·ªói:', error);
                                });
                        }
                    }
                })
                .catch(error => {
                    console.error('ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                });
        });

        // L·∫Øng nghe s·ª± ki·ªán click tr√™n n√∫t "L∆∞u"
        document.getElementById("saveButton").addEventListener("click", function () {
            var actressName = document.getElementById("actressName").value;
            var actressPoint = document.getElementById("point").value;

            saveToApi(actressName, actressPoint);
        });

        // H√†m ƒë·ªÉ l∆∞u d·ªØ li·ªáu l√™n API
        function saveToApi(name, point) {
            fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    name: name,
                    point: point
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u l√™n API:", data);
                    location.reload(); // Reload l·∫°i trang sau khi l∆∞u d·ªØ li·ªáu
                })
                .catch(error => console.error("L·ªói khi l∆∞u d·ªØ li·ªáu:", error));
        }

        function deleteActress(id) {
            fetch(`https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress/${id}`, {
                method: 'DELETE',
            })
                .then(response => response.json())
                .then(data => console.log("ƒê√£ x√≥a:", data))
                .catch(error => console.error("L·ªói khi x√≥a:", error));
        }

        // L·∫Øng nghe s·ª± ki·ªán khi t√†i li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i
        document.addEventListener("DOMContentLoaded", async function () {
            // L·∫•y d·ªØ li·ªáu t·ª´ API v√† hi·ªÉn th·ªã t√™n n·ªØ di·ªÖn vi√™n
            await fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress")
                .then(response => response.json())
                .then(data => {
                    dataValue = data; // Store globally
                    updateActressList(data);

                    // T·∫°o c√°c n√∫t ph√¢n trang ƒë·ªông
                    createPaginationButtons(data.length);

                    // Th√™m s·ª± ki·ªán l·∫Øng nghe cho √¥ t√¨m ki·∫øm
                    // ƒê·ªãnh nghƒ©a c√°c tr∆∞·ªùng c·∫ßn t√¨m ki·∫øm
                    const fieldSearch = ['name', 'point'];

                    document.getElementById("searchByNameAndPoint").addEventListener("input", function () {
                        var searchValue = this.value.toLowerCase();
                        var filteredData = data.filter(actress => {
                            return fieldSearch.some(field => {
                                // Chuy·ªÉn ƒë·ªïi gi√° tr·ªã c·ªßa tr∆∞·ªùng th√†nh chu·ªói ƒë·ªÉ c√≥ th·ªÉ s·ª≠ d·ª•ng includes()
                                const fieldValue = actress[field].toString().toLowerCase();
                                return fieldValue.includes(searchValue);
                            });
                        });

                        updateActressList(filteredData);
                        createPaginationButtons(filteredData.length); // C·∫≠p nh·∫≠t c√°c n√∫t ph√¢n trang sau khi t√¨m ki·∫øm
                    });

                    // H√†m t·∫°o c√°c n√∫t ph√¢n trang
                    function createPaginationButtons(totalItems) {
                        var pagination = document.getElementById("pagination");
                        pagination.innerHTML = ""; // X√≥a c√°c n√∫t ph√¢n trang hi·ªán t·∫°i
                        var totalPages = Math.ceil(totalItems / 10);

                        for (let i = 1; i <= totalPages; i++) {
                            var button = document.createElement("button");
                            button.textContent = `M·ªü trang ${i}`;
                            button.classList.add("pagination-button");
                            button.addEventListener("click", function () {
                                openPages(i, 10);
                            });
                            pagination.appendChild(button);
                        }
                    }

                    // H√†m m·ªü c√°c trang di·ªÖn vi√™n
                    function openPages(pageNumber, itemsPerPage) {
                        var startIndex = (pageNumber - 1) * itemsPerPage;
                        var endIndex = startIndex + itemsPerPage;

                        console.log(`d·ªØ li·ªáu t·ª´ ${startIndex} ƒë·∫øn ${endIndex}   `)
                        console.log("üöÄ ~ openPages ~ startIndex:", startIndex)
                        console.log("üöÄ ~ openPages ~ endIndex:", endIndex)

                        var url = document.getElementById("weburl").value;
                        fetch("https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress")
                            .then(response => response.json())
                            .then(data => {
                                var pageData = data.slice(startIndex, endIndex);
                                pageData.forEach(actress => {
                                    var actressName = actress.name.replace(/\s+/g, '-');
                                    console.log("üöÄ ~ pageData.forEach ~ actressName:", actressName)
                                    openPage(url + actressName);
                                });
                            })
                            .catch(error => console.error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API:", error));
                    }

                    // H√†m ƒë·ªÉ c·∫≠p nh·∫≠t ƒëi·ªÉm c·ªßa di·ªÖn vi√™n th√¥ng qua API
                    async function updateActressPoint(actress) {
                        const newPoint = prompt(`Ch·ªânh l·∫°i ƒëi·ªÉm Point c·ªßa actress: ${actress.point}`);

                        if (newPoint !== null) {
                            try {
                                const response = await fetch(`https://62fbae6be4bcaf53518af2ed.mockapi.io/api/actress/${actress.id}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ point: newPoint })
                                });

                                if (response.ok) {
                                    console.log('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng.');
                                    location.reload();
                                } else {
                                    console.error('L·ªói khi c·∫≠p nh·∫≠t d·ªØ li·ªáu:', response.statusText);
                                }
                            } catch (error) {
                                console.error('L·ªói:', error.message);
                            }
                        }
                    }
                })
                .catch(error => console.error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API:", error));
        });




        // Gi·ªØ nguy√™n ph·∫ßn JavaScript c·ªßa b·∫°n, ch·ªâ c·∫ßn thay ƒë·ªïi h√†m updateActressList

        function updateActressList(data) {
            var actressList = document.getElementById("actressList");
            actressList.innerHTML = ""; // X√≥a danh s√°ch hi·ªán t·∫°i
            data.forEach((actress, index) => {
                var row = document.createElement('tr');
                var actressIndex = index + 1;

                row.innerHTML = `
                    <td>${actressIndex}</td>
                    <td>${actress.name}</td>
                    <td><span class="redPoint">${actress.point}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-btn">Edit</button>
                        <button class="btn btn-sm btn-danger delete-btn">X√≥a</button>
                        <button class="btn btn-sm btn-success search-btn">Search</button>
                    </td>
                `;

                row.querySelector('.edit-btn').addEventListener('click', async function () {
                    await updateActressPoint(actress);
                });

                row.querySelector('.delete-btn').addEventListener('click', function () {
                    deleteActress(actress.id);
                    row.remove();
                });

                row.querySelector('.search-btn').addEventListener('click', function () {
                    var url = document.getElementById("weburl").value;
                    var actressName = actress.name.replace(/\s+/g, '-');
                    openPage(url + actressName);
                });

                actressList.appendChild(row);
            });
        }

        // Ph·∫ßn c√≤n l·∫°i c·ªßa m√£ JavaScript gi·ªØ nguy√™n
    </script>
</body>

</html>